---
title: Представляем Eta v3
description: Новая версия Eta — встроенного шаблонизатора на JS — приносит улучшения в API и документации.
date: "2023-06-22"
tags: [open-source]
---

## Предыстория

Сегодня Eta — мой самый популярный и широко используемый проект с открытым исходным кодом. Но когда я впервые опубликовал его 3 года назад, он не входил в число моих приоритетов. По сути, я создал Eta как облегчённую версию [Squirrelly](https://squirrelly.js.org) — более сложного шаблонизатора с такими возможностями, как хелперы и фильтры.

Со временем я понял, что для большинства проектов встроенный шаблонизатор на самом деле лучше подходит, чем что-то более сложное. Проекты, которым требовалась сложная обработка HTML или обработка на стороне клиента, обычно использовали такие фреймворки, как React или Vue. При этом производительность Eta и небольшой размер бандла делали её отличным выбором для проектов, которым нужна быстрая обработка, низкое потребление памяти или работа с не-XML языками.

В то же время Eta становилась всё популярнее благодаря своей скорости, поддержке Deno и синтаксическим преимуществам по сравнению с EJS. С учётом этих факторов я решил сделать Eta своим главным приоритетом. Я посвятил время написанию руководств, исправлению ошибок и доводке документации.

Спустя несколько лет и перерыв в программировании из‑за миссионерской деятельности у меня наконец появилось время снова заняться Eta. Я решил внести серьёзные изменения в проект, включая систему сборки, API и документацию.

## Обновления системы сборки

Несмотря на преимущества и возможности Eta, у неё были серьёзные проблемы. Одна из них — система сборки. Сложная и громоздкая, её было трудно поддерживать и обновлять. Мне приходилось иметь дело со сложными файлами конфигурации и необходимостью транспилировать отдельную версию специально для Deno.

Изменения в версии 3:

- Переход на [microbundle](https://github.com/developit/microbundle) для сборки библиотеки позволил избежать сложных файлов конфигурации.
- Использование GitHub Actions для запуска тестов и сбора покрытия позволило мне сократить число используемых сервисов.
- Установив `allowImportingTsExtensions: true` в `tsconfig.json`, мне удалось отказаться от [Denoify](https://github.com/garronej/denoify) для отдельной сборки под Deno.

## Изменения в API

Ещё одной проблемой был API. Простые методы вроде `eta.render()` имели множество перегрузок, из-за чего типы было трудно выводить, а использование — неинтуитивным. При вызове функций, доступных пользователю, таких как `render`, `parse` и `compile`, можно было передать пользовательский объект конфигурации. На практике это означало, что каждый раз при вызове любой из этих функций конфигурацию пользователя приходилось сливать с конфигурацией по умолчанию.

Изменения в версии 3:

- Остался только один экспорт — именованный класс `Eta`. У этого класса один конструктор, который обрабатывает объект конфигурации и создаёт кэши шаблонов при инициализации.
- Функции `render()` и `renderAsync()` теперь имеют единственную сигнатуру.
  - В Eta v2 `render()` и `renderAsync()` могли использоваться для рендеринга как именованных шаблонов, так и строк шаблонов. В Eta v3 для рендеринга строк шаблонов добавлены две новые функции: `renderString()` и `renderStringAsync()`.
- Функции `readFile()` и `resolvePath()`, которые Eta использует внутренне, могут быть переопределены пользователем как методы класса.
- Внутренние переменные и методы каждого скомпилированного шаблона теперь хранятся в объекте `__eta`, а не размазаны по нескольким переменным, включая `__res`.
- Вместо указания одной директории `root` и нескольких директорий `views` теперь можно указать только одну директорию `views`. Эта директория используется как корневая для всей резолюции шаблонов. Все файлы шаблонов должны находиться внутри этой директории или её поддиректорий, что повышает безопасность и снижает затраты на поиск файлов.

## Улучшения разработческого опыта

Одним из самых заметных изменений в Eta v3 стало появление подробных ошибок во время выполнения (по мотивам EJS). Рассмотрим такой шаблон, который выбросит ошибку из‑за неинициализированной переменной:

```eta
Заголовок шаблона
<%= undefinedVariable %>
Lorem Ipsum
```

Eta v2 выдавал ошибку с общей информацией, но это было не слишком полезно. Для сравнения, Eta v3 выдаёт подробную ошибку с именем шаблона, номером строки и текстом сообщения об ошибке:

```text
EtaError [ReferenceError]: .../my-dir/templates/runtime-error.eta:2
    1| Заголовок шаблона
 >> 2| <%= undefinedVariable %>
    3| Lorem Ipsum

undefinedVariable не определена
```


## Изменения в документации

Документация по Eta v2 была обширной, но в ней было крайне сложно ориентироваться. Информация о проекте была разбросана более чем по 40 (!) страницам, разложенным по нескольким папкам и трём разным разделам сайта.

Документация по Eta v3 состоит из 9 страниц, все они находятся в одном разделе сайта ([eta.js.org](https://eta.js.org)). Темы вроде синтаксиса шаблонов и обзора API описаны на одной странице, а не разделены по нескольким.

## Будущее Eta

Я горжусь изменениями, вошедшими в Eta v3, и проектом в целом. Большое спасибо всем, кто внес вклад в проект через pull request’ы, issues и предложения. Отдельная благодарность таким проектам, как [ejs](https://github.com/mde/ejs), которыми Eta продолжает вдохновляться.

Сейчас я считаю Eta в основном функционально завершённой, хотя продолжу исправлять ошибки и добавлять небольшие улучшения. Рекомендую текущим пользователям библиотеки обновиться до v3 и надеюсь, что новые пользователи сочтут Eta отличным выбором для своих проектов.

## Ссылки

- [Eta на GitHub](https://github.com/eta-dev/eta)
- [Eta на npm](https://www.npmjs.com/package/eta)
- [Сайт и документация Eta](https://eta.js.org)