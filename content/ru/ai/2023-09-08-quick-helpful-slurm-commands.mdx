---
title: Быстрые и полезные команды Slurm
description: Краткое руководство по использованию Slurm для распределённого обучения с применением машинного обучения.
date: "2023-09-08"
tags: [ml/ai]
---

В лаборатории, где я работаю, у нас есть доступ к вычислительной среде высокого класса (HPC), в которой используется [диспетчер задач Slurm](https://slurm.schedmd.com/documentation.html).

Я пользуюсь ей уже какое-то время и нашёл несколько команд, к которым постоянно возвращаюсь. Поделюсь ими здесь — вдруг кому-то ещё пригодится.

## Проверка статуса задачи

```bash
# Просмотреть все задания
squeue
# Проверить статус только ваших заданий
squeue -u <username>
# Проверить статус заданий с определенным QOS
squeue -q <QOS>
```


## Отмена задач

```bash
# Отменить конкретную задачу
scancel <job_id>
# Отменить все ваши задачи
scancel -u <username>
```


## Запрос узла в интерактивном режиме

```bash
# Запрос одного узла (откроется интерактивная сессия в терминале)
# При выходе из терминала узел будет освобожден
salloc --nodes=1 --gpus=8 --qos=<QOS> --mem=2000G --time=72:00:00 --ntasks=1 --cpus-per-task=128
```


## Отправка задания

Что делать, если все вычислительные узлы заняты или вы не хотите, чтобы задание завершилось сразу после закрытия терминала? В таком случае вы можете использовать `sbatch`, чтобы отправить задание в очередь. Оно автоматически запустится, как только будут выделены ресурсы.

Для этого потребуется немного больше подготовки. Предположим, что задание, которое мы хотим запустить, находится в `myjob.sh`. Чтобы отправить этот скрипт как задание, сначала создадим Bash-скрипт, который будет запущен Slurm. Назовём его `run.sh`:

```bash
#!/bin/bash
#SBATCH -J "ИМЯ_ЗАДАЧИ"
#SBATCH --nodes=1
#SBATCH --gpus-per-node=8
#SBATCH --cpus-per-task=128
#SBATCH --mem=2000G
#SBATCH --time=72:00:00
#SBATCH --qos=<QOS>

srun --nodes=1 myjob.sh
```

Обратите внимание, что мы используем директиву `#SBATCH` для передачи параметров, которые раньше передавали в `salloc`. Мы также используем `srun` для запуска самой задачи; при необходимости он обеспечит выполнение скрипта на нескольких узлах.

Наконец, чтобы запустить наш скрипт, мы выполним:

```bash
sbatch run.sh
```


## Заключение

Вот и всё! Надеюсь, это было полезно. Если у вас есть вопросы, можете обратиться к ChatGPT или Bard (они либо дадут невероятно полезные, либо совершенно неправильные ответы — но попробовать стоит!).

Также можно заглянуть в [документацию Slurm](https://slurm.schedmd.com/documentation.html) или на страницу [конспектов Лео](https://leo.leung.xyz/wiki/Slurm) по Slurm, чтобы узнать больше.