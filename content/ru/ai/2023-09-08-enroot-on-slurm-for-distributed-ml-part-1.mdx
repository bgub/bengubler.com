---
title: "Enroot на Slurm для распределённого ML: часть 1"
description: Как использовать Enroot на Slurm для контейнеризованного обучения на нескольких узлах.
date: "2023-09-08T22:00:00+0000"
tags: [ml/ai]
---

_Это первая часть из двух. [Часть 2](./enroot-on-slurm-for-distributed-ml-part-2) доступна здесь._

В лаборатории, где я работаю, у нас есть доступ к среде высокопроизводительных вычислений (HPC), которая использует [Slurm Workload Manager](https://slurm.schedmd.com/documentation.html). Наша HPC работает на RHEL (Red Hat Enterprise Linux) 7, и права отдельных пользователей существенно ограничены. У нас нет прав `sudo`, и мы не можем выходить в интернет с вычислительных узлов.

Процесс установки пакетов и обновления драйверов на вычислительном узле настолько сложен, что распределённое обучение с использованием современного ПО сильно усложняется. К счастью, есть решение: контейнеризация.

Мы используем Docker, чтобы собрать образ на локальной машине со всеми нужными пакетами. Затем можно перенести этот образ на HPC и использовать его для запуска тренировочного скрипта.

## Шаг 1: Соберите Docker-образ локально

Я уже писал о [настройке Docker для машинного обучения](./ultimate-ml-dockerfile), поэтому здесь повторяться не буду. Важно, чтобы у вас был помеченный тегом Docker-образ с нужными пакетами для запуска тренировочного скрипта. У меня — Ubuntu 20.04 и CUDA 11.8.

## Шаг 2: Сжать и перенести образ

Установите [Enroot](https://github.com/NVIDIA/enroot), затем выполните следующую команду, чтобы преобразовать Docker-образ в файл squashfs:

```bash
enroot import dockerd://<image-name>
```

В текущем каталоге будет создан файл `<image-name>.sqsh`. Перенесите его на HPC с помощью `scp`.


## Шаг 3: Загрузка образа на HPC-кластер

Зайдите на вычислительный узел с помощью `salloc --nodes=1 --gpus=8 --qos=<qos> --mem=2000G --time=72:00:00 --ntasks=1 --cpus-per-task=128`.

Сначала нужно загрузить модуль Enroot:

```bash
module load jq zstd pigz parallel libnvidia-container enroot
```

На HPC создайте образ следующей командой:

```bash
enroot create --name image-name /path/to/image-name.sqsh
```

Затем запустите это:

```bash
enroot start --mount /local/file/path:/image/file/path \
             --rw image-name bash
```

Это откроет интерактивную оболочку внутри контейнера. Не забудьте про флаг `--rw`, который делает корневую файловую систему доступной для записи. Вы можете добавить столько флагов `--mount`, сколько нужно, чтобы подключить файлы и каталоги с хостовой машины.

Если нужно передать переменные окружения, используйте флаг `--env` вместе с именем переменной на хостовой машине. Например, `--env SLURM_NODEID` пробросит переменную окружения `SLURM_NODEID`.
