---
title: "Enroot على Slurm للتعلّم الآلي الموزّع: الجزء 1"
description: كيفية استخدام Enroot على Slurm للتدريب متعدد العقد ضمن حاويات.
date: "2023-09-08T22:00:00+0000"
tags: [ml/ai]
---

_هذا هو الجزء 1 من سلسلة مؤلّفة من جزأين. [الجزء 2](./enroot-on-slurm-for-distributed-ml-part-2) متاح هنا._

في المختبر الذي أعمل فيه، لدينا وصول إلى بيئة حوسبة عالية الأداء (HPC) تستخدم [Slurm Workload Manager](https://slurm.schedmd.com/documentation.html). يعمل نظام الـHPC لدينا على RHEL (Red Hat Enterprise Linux) 7، وتكون صلاحيات المستخدمين الأفراد مقيّدة بشكل كبير. لا نملك صلاحيات `sudo` ولا يمكننا الوصول إلى الإنترنت من عقد الحوسبة.

في الواقع، إن عملية تثبيت الحزم وتحديث برامج التشغيل من داخل عقدة حوسبة صعبة إلى حد يجعل التدريب الموزّع باستخدام البرمجيات الحديثة معقّدًا للغاية. لحسن الحظ، هناك حل: الحاويات (containerization).

سنستخدم Docker لبناء صورة على جهازنا المحلي تحتوي على جميع الحزم التي نحتاجها. بعد ذلك يمكننا نقل تلك الصورة إلى بيئة الـHPC واستخدامها لتشغيل برنامج التدريب الخاص بنا.

## الخطوة 1: إنشاء صورة Docker محليًا

سبق أن كتبت عن [إعداد Docker الذي أستخدمه لتعلّم الآلة](./ultimate-ml-dockerfile)، لذا لن أكرر التفاصيل هنا. المهم أن تكون لديك صورة Docker مميّزة بعلامة (tag) وتضم الحزم التي تحتاجها لتشغيل سكربت التدريب. صورتي مبنية على Ubuntu 20.04 وتستخدم CUDA 11.8.

## الخطوة 2: دمج الصورة ونقلها

ثبّت [Enroot](https://github.com/NVIDIA/enroot)، ثم شغّل الأمر التالي لتحويل صورة Docker الخاصة بك إلى ملف squashfs:

```bash
enroot import dockerd://<image-name>
```

سيُنشئ هذا ملفًا باسم `<image-name>.sqsh` في الدليل الحالي. انقل هذا الملف إلى نظام HPC باستخدام `scp`.


## الخطوة 3: تحميل الصورة على نظام الحوسبة عالية الأداء (HPC)

ادخل إلى عقدة حوسبة باستخدام الأمر التالي: `salloc --nodes=1 --gpus=8 --qos=<qos> --mem=2000G --time=72:00:00 --ntasks=1 --cpus-per-task=128`.

أولاً، نحتاج إلى تحميل وحدة Enroot:

```bash
module load jq zstd pigz parallel libnvidia-container enroot
```

على نظام الحوسبة عالية الأداء (HPC)، أنشئ الصورة باستخدام الأمر التالي:

```bash
enroot create --name image-name /path/to/image-name.sqsh
```

ثم شغِّله:

```bash
enroot start --mount /local/file/path:/image/file/path \
             --rw image-name bash
```

سيؤدي هذا إلى فتح غلاف تفاعلي داخل الحاوية. لا تنسَ الخيار `--rw`، الذي يجعل نظام ملفات الجذر قابلاً للكتابة. يمكنك إضافة أي عدد من خيارات `--mount` حسب حاجتك لضمّ الملفات والمجلدات من جهاز المضيف.

إذا أردت تمرير متغيرات بيئة، يمكنك استخدام الخيار `--env` مع اسم متغير البيئة على جهاز المضيف. على سبيل المثال، سيؤدي `--env SLURM_NODEID` إلى تمرير متغير البيئة `SLURM_NODEID`.
